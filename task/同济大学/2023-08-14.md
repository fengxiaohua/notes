问题：
    日志插件问题：记录响应，urlPath单一，有些好像没记录上
测试环境gitlab-runner 上传docker镜像

使用矩阵构建

.kaniko-build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/${DOCKERFILE}"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}"
  rules:
    - if: $CI_COMMIT_TAG

docker-build:
  extends: .build
  parallel:
    matrix:
      - DOCKERFILE: ${CI_PROJECT_DIR}/dockerfiles/A.dockerfile
      - DOCKERFILE: ${CI_PROJECT_DIR}/dockerfiles/B.dockerfile




stages:
  - build
  - deploy

variables:
  CI_REGISTRY_IMAGE: se2300001/open-platform

.build:
  image: docker:stable
  stage: build
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - IMAGE_TAGGED=$CI_REGISTRY/$CI_REGISTRY_IMAGE/$CONTAINER_NAME:$CI_COMMIT_TAG
    - IMAGE_LATEST=$CI_REGISTRY/$CI_REGISTRY_IMAGE/$CONTAINER_NAME:latest

    # nginx dockerfile 路径比较特殊，需要特殊化处理一下
    - | if ["$CONTAINER_NAME" === "."]; then
          docker build -f $CONTAINER_NAME/Dockerfile $PATH/ -t $IMAGE_TAGGED
        else
          docker build -f $CONTAINER_NAME/Dockerfile $PATH/ -t $IMAGE_TAGGED
        fi
    
      docker tag $IMAGE_LATEST $IMAGE_TAGGED

    - docker push $IMAGE_TAGGED
    - docker push $IMAGE_LATEST
  tags:
    - openplat-form-runner
  only:
    - tags


build-nginx:
  extends: .build
  variables:
    CONTAINER_NAME: "nginx"
  
build-keycloak:
  extends: .build
  variables:
    CONTAINER_NAME: "keycloak"

# build-job1:
#   image: docker:stable
#   stage: build-nginx
#   before_script:
#     - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
#   script:
#     - echo "Building build-nginx..."
#     - docker build -f nginx/Dockerfile ./ -t $CI_REGISTRY/$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_TAG
#     - docker push $CI_REGISTRY/$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_TAG
#   tags:
#     - openplat-form-runner
#   only:
#     - tags

# build-job2:
#   image: docker:stable
#   stage: build-keycloak
#   before_script:
#     - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
#   script:
#     - echo "Building build-nginx..."
#     - docker build -f keycloak/Dockerfile keycloak/ -t $CI_REGISTRY/$CI_REGISTRY_IMAGE/keycloak:$CI_COMMIT_TAG
#     - docker push $CI_REGISTRY/$CI_REGISTRY_IMAGE/keycloak:$CI_COMMIT_TAG
#   tags:
#     - openplat-form-runner
#   only:
#     - tags

deploy:
  image: ringcentral/sshpass
  stage: deploy
  script:
    - echo "Deploy ..."
    - "sshpass -p 'CSC97Ugczp8muraX' ssh -o StrictHostKeyChecking=no -t $USER@$IPADDRESS 'cd /home/Open-Platform; docker-compose up -d; docker start $(docker ps -aq)'"
  only:
    - tags