已完成：
1. 等保测评
2. nginx配置特殊接口返回1并记录日志
3. 解析lua dept逻辑并编写 go http clent 插件
4. keycloak client支持导出功能(还不完善)

lua dept脚本替换为插件形式
1. userId 可能在query/body中 不存在body中的情况（datacenter_single_query_interface.json）✅
2. lua不能将错误给用户 ✅
3. 如果userId 500个（直接拦截告诉用户 请求参数userId数量超过上限）✅
4. 如何告诉用户错误？
5. 如何优化性能 ❓

go插件替换
1. 迁移原有代码逻辑✅
    set_dept_code逻辑：
        1. 检查是否存在 JWT（通过检查请求头中的 "Authorization" 字段）。 
        2. 解析 JWT，提取其中的 "dept_code" 值。 
        3. 检查 "dept_code" 值是否存在，如果不存在则说明不需要进行权限检验，直接返回。 
        4. 检查查询参数中是否存在 "deptCode" 字段。 
            - 如果不存在，则将 "dept_code" 值添加到查询参数中。 
            - 如果存在，则替换查询参数中的 "deptCode" 值为 "dept_code" 值。 
    validate_dept_code逻辑：

2. 添加userId 可能在query/body中的逻辑（多个userId）
3. 错误的userId返回告诉用户

401报错
		ip, err1 := getIP(req)
		fmt.Println(err1)
		currentTime := time.Now()
		formattedTime := currentTime.Format("2006/01/02 15:04:05")
		content := "[plugin-response-log] | " + formattedTime + " | ip: " + ip + " | method: " + req.Method + " | urlPath: " + req.URL.Path + " | query: " + req.URL.RawQuery + " | params: " + req.Form.Encode() + " | IsComplete: false | data: no auth header" + " | statusCode: 401"
		fmt.Println(content)



payResult


krakend.json
{
  "$schema": "https://www.krakend.io/schema/v3.json",
"version": 3,
  "timeout": "100000ms",
  "cache_ttl": "300s",
  "host": [
    "http://fake_api:8080"
  ],
  "plugin": {
    "pattern": ".so",
    "folder": "/etc/krakend/plugins/"
  },
  "extra_config": {
    "plugin/http-server": {
      "name": "krakend-request-log",
      "krakend-request-log": {
      }
    },
    "telemetry/metrics": {
      "collection_time": "30s",
      "listen_address": ":8090"
    },
    "telemetry/influx": {
      "address": "http://influxdb:8086",
      "ttl": "25s"
    },
    "telemetry/logging": {
      "level": "DEBUG",
      "prefix": "[KRAKEND]",
      "syslog": false,
      "stdout": true
    },
    "telemetry/opencensus": {
      "sample_rate": 100,
      "reporting_period": 1,
      "exporters": {
        "jaeger": {
          "endpoint": "http://jaeger:14268/api/traces",
          "service_name": "krakend"
        }
      }
    },
    "security/cors": {
      "#comment":"我已经忘了这玩意设置个啥了 简单解决下跨域问题 这么做也许不安全 但是先解决 后续再研究如何弄的更简单",
      "allow_origins": [
        "http://localhost:8080",
        "http://localhost:3000",
        "http://localhost*",
        "http://192.168.99.100:3000",
        "http://10.10.175.237:8081",
        "https://api.tongji.edu.cn",
        "http://api.tongji.edu.cn",
        "*"
      ],
      "allow_methods": [
        "POST",
        "GET"
      ],
      "allow_headers": [
        "Origin",
        "Authorization",
        "Content-Type"
      ],
      "expose_headers": [
        "Content-Length"
      ],
      "max_age": "12h"
    },
    "auth/revoker": {
      "N": 10000000,
      "P": 0.0000001,
      "hash_name": "optimal",
      "TTL": 1500,
      "port": 1234,
      "token_keys": [
        "jti"
      ]
    }
  },
  "endpoints": [
    {{ include "keycloak.json" }},
    {{ include "old.json" }},
    {{ include "test.json" }}
    {{ range $idx, $endpoint := .metadata.metadata_group }}
    ,{
      "#comment": "{{ $endpoint.comment }}",
      "endpoint": "/v1/metadata{{ $endpoint.endpoint }}",
      "extra_config":{
        "plugin/req-resp-modifier":{
          "name": [
                "krakend-debugger-request",
                "krakend-debugger-response"
          ]
        }
      },
      "input_query_strings": [
        "*"
      ],
      "backend": [
        {
          "host": "http://romasite.tongji.edu.cn",
          "url_pattern": "{{ $endpoint.url_pattern }}",
          "extra_config": {
            "backend/http": {
              "return_error_details": "error"
            }
          }
        }
      ]
    }
    {{ end }}
    {{ range $idx, $endpoint := .datacenter_single_query_interface.interface_group }}
    {{ $host := "http://romasite.tongji.edu.cn" }}
    {{ if ($endpoint.host)}}{{ $host =  $endpoint.host }}{{ end }}
    {{ $myDict := dict "endpoint" $endpoint "goFunc" "validate_dept_code" "host" $host }}
    ,{{ template "standard.tmpl" $myDict }}
    {{ end }}
    {{ range $idx, $endpoint := .datacenter_common_interface.interface_group }}
    {{ $host := "http://romasite.tongji.edu.cn" }}
    {{ if ($endpoint.host)}}{{ $host =  $endpoint.host }}{{ end }}
    {{ $myDict := dict "endpoint" $endpoint "goFunc" nil "host" $host }}
    ,{{ template "standard.tmpl" $myDict }}
    {{ end }}
    {{ range $idx, $endpoint := .datacenter_batch_query_interface.interface_group }}
    {{ $myDict := dict "endpoint" $endpoint "goFunc" "set_dept_code" "host" "http://romasite.tongji.edu.cn"}}
    ,{{ template "standard.tmpl" $myDict }}
    {{ end }}
  ]
}


stander
{
      {{ $endpoint:= first (pluck "endpoint" .)}}
      "#comment": "{{ $endpoint.comment }}",
      {{if ($endpoint.method)}}
      "method": "{{ $endpoint.method }}",
      {{end}}
      {{if ($endpoint.type)}}
      "endpoint": "/v1/{{ $endpoint.type }}{{ $endpoint.endpoint }}",
      {{else}}
      "endpoint": "/v1/dc{{ $endpoint.endpoint }}",
      {{end}}
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "http://keycloak:8080/auth/realms/OpenPlatform/protocol/openid-connect/certs",
          "#issuer": "http://keycloak:8403/auth/realms/OpenPlatform",
          "disable_jwk_security": true,
          {{if ($endpoint.type)}} 
          {{ $extracted_scopes := concat (list $endpoint.type) ($endpoint.endpoint | splitList "/") | compact }}
          {{ $extracted_scopes := append ($extracted_scopes | initial) ($extracted_scopes | join "_") | rest | join "\",\"" }}
          {{ $extracted_scopes := cat "\"" $extracted_scopes "\"" | replace " " "" | splitList "," }}
          {{ if ($endpoint.scopes) }}
          {{ $original_scopes := marshal $endpoint.scopes | replace "[" "" | replace "]" "" | splitList ","}}
          {{ $all_scopes := concat $original_scopes $extracted_scopes | uniq | join "," }}
          "scopes": ["lordofthering",{{$all_scopes}}],
          {{else}}
          {{ $all_scopes := $extracted_scopes | uniq | join "," }}
          "scopes": ["lordofthering",{{$all_scopes}}],
          {{end}}
          {{else}}
          {{ $extracted_scopes := concat (list "dc" ) ($endpoint.endpoint | splitList "/") | compact }}
          {{ $extracted_scopes := append ($extracted_scopes | initial) ($extracted_scopes | join "_") | rest | join "\",\"" }}
          {{ $extracted_scopes := cat "\"" $extracted_scopes "\"" | replace " " "" | splitList "," }}
          {{if ($endpoint.scopes) }}
          {{ $original_scopes := marshal $endpoint.scopes | replace "[" "" | replace "]" "" | splitList "," }}
          {{ $all_scopes := concat $original_scopes $extracted_scopes | uniq | join "," }}
          "scopes": ["lordofthering",{{$all_scopes}}],
          {{else}}
          {{ $all_scopes := $extracted_scopes | uniq | join "," }}
          "scopes": ["lordofthering",{{$all_scopes}}],
          {{end}}
          {{end}}
          "scopes_matcher": "any",
          "scopes_key": "scope"
        },
        "plugin/req-resp-modifier":{
          "name": [
                "krakend-debugger-request",
                "krakend-debugger-response"
          ]
        }
      },
      "input_headers":[
        "Authorization",
        "Content-Type"
      ],
      "input_query_strings": [
        "*"
      ],
      "backend": [
        {
          "host": "{{first (pluck "host" .)}}",
          "url_pattern": "{{$endpoint.url_pattern}}",
          "extra_config": {
            "backend/http": {
              "return_error_details": "error"
            }
            {{if (first (pluck "goFunc" .))}}
            ,"plugin/http-client": {
              "name": "krakend-client",
              "krakend-client": {
                "func": "{{first (pluck "goFunc" .)}}"
              }
            }
            {{end}}
          }
        }
      ]
    }
  

  服务器，数据库 登录策略，失败锁定密码更换，密码复杂度

  